<head profile="http://gmpg.org/xfn/11"><link rel="stylesheet" type="text/css" href="A.css" media="all">

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="http://siteapp.baidu.com/static/webappservice/uaredirect.js" type="text/javascript"></script><script type="text/javascript">uaredirect("http://siteapp.baidu.com/webapp/caosz.com","http://caosz.com");</script>
  <meta name="baidu-tc-cerfication" content="b991bb6ba1f32749a275b30d6a3c7f30">
  <title>君子不器 </title>
  <link rel="pingback" href="http://caosz.com/xmlrpc.php">
  <link rel="stylesheet" id="prana-google-fonts-css" href="http://fonts.googleapis.com/css?family=Open+Sans%7CBitter&amp;ver=3.8.3" type="text/css" media="all"> <!--font of article title -->
  <style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
  <style type="text/css" id="custom-background-css">
	body.custom-background { background-color: #fff; }
  </style>
</head>

<body>
  <div class="wrapper">
	<!-- head -->
	<div id="header">  
      <!--title-->
	  <div class="container_16 container_header_top clearfix">
		<div class="grid_16">
		  <div id="headimg">
			<div id="logo-text">
			  <span class="site-name"><a href="http://caosz.com/" title="流年似水" rel="home">君子不器</a></span>
			  <span class="site-description">弘毅·任重而道远</span>
			</div><!-- end of #logo -->
			
			
		</div>        </div>
      </div>
      

      <!-- description -->
      <div class="container_16 clearfix">
		<div class="grid_16">
          <div id="nav">
			<div class="menu clearfix"><ul id="menu-%e8%8f%9c%e5%8d%951" class="sf-menu sf-js-enabled">
				<li id="menu-item-256" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item menu-item-home menu-item-256"><a href="https://github.com/whispermemory/gitblog"> fork me on github </a></li>
				<!--li id="menu-item-257" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-257"><a href="http://caosz.com/%e5%85%b3%e4%ba%8e%e8%87%aa%e6%88%91/"></a></li>
					<li id="menu-item-258" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-258"><a href="http://caosz.com/%e7%95%99%e8%a8%80/">留言</a></li-->
			</ul></div>  
          </div>
		</div>
      </div>
	  
	</div> 
	<!--end head-->

	<!--article-->
	<div class="container_16 clearfix">
	  <div class = "grid_12">
		<div id="content">
                  <!--append-->
          <div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
            <h2 class="entry-title"> <font color="green">使用 md 转换 html 来连接 emacs 和 blog </font> </h2>
            <div class="entry-meta">2014-07-06 16:06</div>
            <div class="entry-content clearfix"><p style="padding-left: 30px;">
              </p><p style="padding-left: 30px;"><ul>
              </p><p style="padding-left: 30px;"><li>用于创建笔记</li>
              </p><p style="padding-left: 30px;"><li>整理心得</li>
              </p><p style="padding-left: 30px;"><li>emacs 编辑之后 github 直接提交</li>
              </p><p style="padding-left: 30px;"><li>可以拷贝别人的前端</li>
              </p><p style="padding-left: 30px;"><li>先不考虑评论</li>
              </p><p style="padding-left: 30px;"><li>生成一个可执行文件，该可执行文件能够将 md 格式直接插入到已经存在的静态文件中</li>
              </p><p style="padding-left: 30px;"><li>静态文件自己。</li>
              </p><p style="padding-left: 30px;">
              </p><p style="padding-left: 30px;"><li><p>在 emacs 中执行该文件，然后调用 github 的 emacs 函数提交生成后的文件</p></li>
              </p><p style="padding-left: 30px;">
              </p><p style="padding-left: 30px;"><li><p>md 文件转换成 html 文件(markdown mode 里面应该有相应的方法)</p></li>
              </p><p style="padding-left: 30px;">
              </p><p style="padding-left: 30px;"><li><p>拷贝到需要的静态文件中，该文件应该是分散的文件，通过 pandoc 文件组合到一个 html 里面</p></li>
              </p><p style="padding-left: 30px;">
              </p><p style="padding-left: 30px;"><li><p>上传该 html</p></li>
              </p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>println(&#34;hello, github&#34;)
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p></div>
</div>
<div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
<h2 class="entry-title"> <font color="green">emacs 提交 md 文件到 github 首页流程</font> </h2>
<div class="entry-meta">2014-07-07 19:07</div>
<div class="entry-content clearfix"><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>markdown 转成 html</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>$   git clone git@github.com:whispermemory/gitblog.git
</p><p style="padding-left: 30px;">$   cd gitblog
</p><p style="padding-left: 30px;">$   export GOPATH=`pwd`
</p><p style="padding-left: 30px;">$   go build src/gitblog.go
</p><p style="padding-left: 30px;">$   cp src/gitblog  /usr/local/bin/
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>实现 github 提交 shell</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>cd $1
</p><p style="padding-left: 30px;">git add index.html
</p><p style="padding-left: 30px;">git commit -m&#34;push blog&#34;
</p><p style="padding-left: 30px;">git push origin gh-pages
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>在 emacs 中提交 md 文件</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>hook markdown mode</li>
</p><p style="padding-left: 30px;"><li>在 .emacs 文件中添加如下代码</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>
</p><p style="padding-left: 30px;">(defun postmd()
</p><p style="padding-left: 30px;">(interactive)
</p><p style="padding-left: 30px;">(setq compile_filename (buffer-name (current-buffer)))
</p><p style="padding-left: 30px;">(setq cmdstr (concat &#34;gitblog &#34;  compile_filename &#34; &#34; &#34;/Users/whispermemory/my_src/gitblog/index.html&#34;))
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">(shell-command cmdstr)
</p><p style="padding-left: 30px;">)
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">(defun pushmd()
</p><p style="padding-left: 30px;">(interactive)
</p><p style="padding-left: 30px;">(shell-command &#34;bash pushmd.sh ~/my_src/gitblog/&#34;)
</p><p style="padding-left: 30px;">)
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">(add-hook &#39;markdown-mode-hook (lambda ()
</p><p style="padding-left: 30px;">(local-set-key (kbd &#34;F8&#34;) &#39;postmd)))
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">(add-hook &#39;markdown-mode-hook (lambda ()
</p><p style="padding-left: 30px;">(local-set-key (kbd &#34;F9&#34;) &#39;pushmd)))
</p><p style="padding-left: 30px;"></code></pre>
</p></div>
</div>
<div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
<h2 class="entry-title"> <font color="green">git 基本使用</font> </h2>
<div class="entry-meta">2014-07-08 09:08</div>
<div class="entry-content clearfix"><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>.git</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>.git 文件位于项目的起始目录下</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>➜$ ls
</p><p style="padding-left: 30px;">COMMIT_EDITMSG HEAD           branches       description    index          logs           objects
</p><p style="padding-left: 30px;">FETCH_HEAD     ORIG_HEAD      config         hooks          info           modules        refs
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>ORIG_HEAD</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>$ cat ORIG_HEAD
</p><p style="padding-left: 30px;">15687c5d6eb32c28c3e151526d43e6878eae6afa
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>ORIG_HEAD 中的 40 位字符串指向的是 commit 对象</li>
</p><p style="padding-left: 30px;"><li>该 commit 对象保存了最近一次 push 之前 github 状态。用于 push 的撤销。</li>
</p><p style="padding-left: 30px;"><li>commit 对象里面保存了相关的 diff 信息</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>$ git show 15687c5d6eb32c28c3e151526d43e6878eae6afa
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">commit 15687c5d6eb32c28c3e151526d43e6878eae6afa
</p><p style="padding-left: 30px;">Author: whispermemory &lt;whispermemory@gmail.com&gt;
</p><p style="padding-left: 30px;">Date:   Mon Jul 7 15:54:50 2014 +0800
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">init submodule
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">diff --git a/.gitmodules b/.gitmodules
</p><p style="padding-left: 30px;">new file mode 100644
</p><p style="padding-left: 30px;">index 0000000..18862e6
</p><p style="padding-left: 30px;">--- /dev/null
</p><p style="padding-left: 30px;">+++ b/.gitmodules
</p><p style="padding-left: 30px;">@@ -0,0 +1,3 @@
</p><p style="padding-left: 30px;">+[submodule &#34;blackfriday&#34;]
</p><p style="padding-left: 30px;">+       path = blackfriday
</p><p style="padding-left: 30px;">+       url = /Users/whispermemory/my_src/gitblog/src/github.com/russross/blackfriday
</p><p style="padding-left: 30px;">diff --git a/blackfriday b/blackfriday
</p><p style="padding-left: 30px;">new file mode 160000
</p><p style="padding-left: 30px;">index 0000000..7680f7f
</p><p style="padding-left: 30px;">--- /dev/null
</p><p style="padding-left: 30px;">+++ b/blackfriday
</p><p style="padding-left: 30px;">@@ -0,0 +1 @@
</p><p style="padding-left: 30px;">+Subproject commit
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>可以用这个索引来恢复数据到上次 push 的状态</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>git reset --hard ORIG_HEAD
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>同样的要恢复到上次 commit 的状态</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>git reset --hard HEAD
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>commit 对象</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>commit 对象使用 40 位字符串进行索引</li>
</p><p style="padding-left: 30px;"><li>每次 commit 都会包含相关文件夹，文件 和相关 commit</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>$ git ls-tree 15687c5d6eb32c28c3e151526d43e6878eae6afa
</p><p style="padding-left: 30px;">100644 blob 18862e6288a1b3e0727feca362cf6ef12beffb29	.gitmodules
</p><p style="padding-left: 30px;">100644 blob 451f0aa56a737800adeed08d0658c2e0f6d6bbfc	A.css
</p><p style="padding-left: 30px;">100644 blob 0fb8b05532ec2caa638a0c2fadc7ca588774c77d	CNAME
</p><p style="padding-left: 30px;">100644 blob 9282d22af4df76e1afb55dea752b77adc6943974	README.md
</p><p style="padding-left: 30px;">160000 commit 7680f7fdeb0d57222f62d02802af5e3585722384	blackfriday
</p><p style="padding-left: 30px;">040000 tree 2f575a23aec5e9922c4822cdc6ac3a12543fd3ac	images
</p><p style="padding-left: 30px;">100644 blob 64b5b259769db3493c83f3146ebd2c0944f69ed9	index.html
</p><p style="padding-left: 30px;">040000 tree b5484ac6806b1cc2899a9f615e9439a46b850781	javascripts
</p><p style="padding-left: 30px;">100644 blob f19e9a9b74690b79b222d541c9edd16c48983098	params.json
</p><p style="padding-left: 30px;">040000 tree a6d238546007c7fc1f715fed9d257765527cf7ab	pkg
</p><p style="padding-left: 30px;">100644 blob df83e41df19af5952f53bde9cb61eb200442d553	preview.png
</p><p style="padding-left: 30px;">040000 tree 1cc8fcb88b1af4672db609faeb79897d410a4215	src
</p><p style="padding-left: 30px;">040000 tree db1a9428acf5e44a0dc31f16bfdddb6563f4f774	stylesheets
</p><p style="padding-left: 30px;">➜```
</p><p style="padding-left: 30px;">*  blob 是这次修改到得文件的内容
</p><p style="padding-left: 30px;">*  tree 是本次修改文件夹的内容
</p><p style="padding-left: 30px;">*  commit 也是一个 tree, 可以使用 git ls-tree db1a9428acf5e44a0dc31f16bfdddb6563f4f774
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">## merge ##
</p><p style="padding-left: 30px;">*  适用于不同分支不同版本之间合并 A B
</p><p style="padding-left: 30px;">*  针对于 B commit 对象而合并
</p><p style="padding-left: 30px;">*  merge 之后 A 处于未提交状态
</p><p style="padding-left: 30px;">*  B 可以作为一个临时的版本删除掉
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>$  git branch -d  B</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>*  冲突解决
</p><p style="padding-left: 30px;">*  A 有 commit 未提交的时候需要 git stash
</p><p style="padding-left: 30px;">*  切换到 B , 令 A commit 的文件与 B 的相同文件产生不同
</p><p style="padding-left: 30px;">*  切换到 A, git merge B, 提示
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>$    git merge test
</p><p style="padding-left: 30px;">Auto-merging README.md
</p><p style="padding-left: 30px;">CONFLICT (content): Merge conflict in README.md
</p><p style="padding-left: 30px;">Automatic merge failed; fix conflicts and then commit the result.</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>*  手动修改冲突文件之后，再次 add 并 commit 文件
</p><p style="padding-left: 30px;">*  删除 B 分支
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>$    git branch -d B
</p><p style="padding-left: 30px;">```</p>
</p></div>
<div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
<h2 class="entry-title"> <font color="green">golang  pool 模式</font> </h2>
<div class="entry-meta">2014-07-11 10:11</div>
<div class="entry-content clearfix"><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>routine pool 的引入</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>routine 创建与销毁需要时间与内存消耗</li>
</p><p style="padding-left: 30px;"><li>routine 数目不宜过多，会有调度的消耗</li>
</p><p style="padding-left: 30px;"><li>使用单一 IO 进行并发按行文本分析。文本约 800W 行。</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>    f = open()
</p><p style="padding-left: 30px;">    for {
</p><p style="padding-left: 30px;">        line = r.ReadString()
</p><p style="padding-left: 30px;">		go handle(line)
</p><p style="padding-left: 30px;">    }
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用非常驻 routine, 平均 4 个 routine /s</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>@smile-5:~/perl-test$ time ./mapip &amp;&gt; a.txt</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    3m7.854s
</p><p style="padding-left: 30px;">user    2m27.713s
</p><p style="padding-left: 30px;">sys 0m5.049s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>func handleOnChan() {
</p><p style="padding-left: 30px;">    x&lt;-chanX
</p><p style="padding-left: 30px;">    handle(x)
</p><p style="padding-left: 30px;">}
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">for (i--poolSize) {
</p><p style="padding-left: 30px;">    go handleOnChan()
</p><p style="padding-left: 30px;">}
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;">for {
</p><p style="padding-left: 30px;">    line = readString()
</p><p style="padding-left: 30px;">    chanX &lt;-line
</p><p style="padding-left: 30px;">}
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用常驻 routine 减少 routine 分配时间</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 8 个 routine</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    2m52.572s
</p><p style="padding-left: 30px;">user    2m54.466s
</p><p style="padding-left: 30px;">sys 0m5.159s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 18 个</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    2m13.851s
</p><p style="padding-left: 30px;">user    2m54.506s
</p><p style="padding-left: 30px;">sys 0m4.757s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 180 个</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    1m52.662s
</p><p style="padding-left: 30px;">user    3m4.992s
</p><p style="padding-left: 30px;">sys 0m4.354s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 900 个</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    2m3.887s
</p><p style="padding-left: 30px;">user    3m19.644s
</p><p style="padding-left: 30px;">sys 0m4.236s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 1800 个</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    2m11.000s
</p><p style="padding-left: 30px;">user    3m25.211s
</p><p style="padding-left: 30px;">sys 0m4.855s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>100</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    1m58.240s
</p><p style="padding-left: 30px;">user    3m9.223s
</p><p style="padding-left: 30px;">sys 0m4.398s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>50</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>real    2m20.172s
</p><p style="padding-left: 30px;">user    3m1.101s
</p><p style="padding-left: 30px;">sys 0m4.487s</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>并发池</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>用于通信的 channel 池</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>var pool chan chan *Message
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>每一个 chan *Message 对应一个 routine</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>for index&lt;poolSize{
</p><p style="padding-left: 30px;">    var c chan *Message = make(*Message ,1)
</p><p style="padding-left: 30px;">    go routine(chan messchan)
</p><p style="padding-left: 30px;">	c&lt;-nil
</p><p style="padding-left: 30px;">}
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>每一个 routine 都常驻</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>for {
</p><p style="padding-left: 30px;">   message := &lt;-messchan
</p><p style="padding-left: 30px;">   if message = nil {
</p><p style="padding-left: 30px;">        pool&lt;-messchan
</p><p style="padding-left: 30px;">   }
</p><p style="padding-left: 30px;">   handle(message)
</p><p style="padding-left: 30px;">}
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>需要处理一个事件时，取一个消息管道</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>   c := &lt;-pool
</p><p style="padding-left: 30px;">   var m *Message = &amp;Message{}
</p><p style="padding-left: 30px;">   c&lt;-m
</p><p style="padding-left: 30px;"></code></pre>
</p></div>
</div>
<div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
<h2 class="entry-title"> <font color="green">golang gc</font> </h2>
<div class="entry-meta">2014-07-22 17:22</div>
<div class="entry-content clearfix"><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>golang gc 采用的是一种简单的 mark &amp; sweep 算法。每隔 2 s 就挂起所有 routine 扫描对象并标记，进行 sweep。 这种算法有一个弊端是每次 gc 如果时间太长会对业务产生影响。</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>优化 gc</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>对日志文件切割传输遇到 gc 问题。每次 gc 时间超长</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>通过  GODEBUG=gctrace=1 查看 gc 日志</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>GODEBUG=gctrace=1 ./proc &amp;&gt; gclog.txt</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>gc27(2): 297+37+284891+13 us, 305 -&gt; 611 MB, 5772810 (35644683-29871873) objects, 70356/7344/0 sweeps, 9(529) handoff, 5(3030) steal, 95/27/1 yields
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>这次 gc 释放了 5772810 个对象。全局持有 29871873 个对象。耗时 284us = 0.2s。</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>优化思路</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>1  比较各种数据类型之间的优化复杂度
</p><p style="padding-left: 30px;">2  确定为什么 slice 是比较容易优化的。 参见 <a href="http://1234n.com/?post/yzsrwa。">http://1234n.com/?post/yzsrwa。</a>
</p><p style="padding-left: 30px;">3  用手动 slice 替换系统 slice<br/>
</p><p style="padding-left: 30px;">4  确定 string 和 slice 的差距
</p><p style="padding-left: 30px;">5  找到测试 gc 的好办法    Lookup(“heap)</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>gc 优化目标–尽量减少 gc 时间消耗
</p><p style="padding-left: 30px;">1&gt; 使用易 gc 对象
</p><p style="padding-left: 30px;">2&gt; 使用内存池
</p><p style="padding-left: 30px;">3&gt; 减少生成的对象，使用生成对象少得类型(slice of struct)
</p><p style="padding-left: 30px;">4&gt; slice 要用对象类型而非对象指针类型</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>查看生成 1w 个数据生成对象数量</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>slice #</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>go vertion 1.2
</p><p style="padding-left: 30px;">*  HeapObjects = 10114
</p><p style="padding-left: 30px;">*  Stack = 81494016 / 81657856
</p><p style="padding-left: 30px;">*  MSpan = 78000 / 81920
</p><p style="padding-left: 30px;">*  MCache = 1504 / 16384
</p><p style="padding-left: 30px;">*  BuckHashSys = 1480848
</p><p style="padding-left: 30px;">*  NextGC = 6372976
</p><p style="padding-left: 30px;">*  PauseNs = [166380 55454 6114040</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>go version 1.3
</p><p style="padding-left: 30px;">* HeapObjects = 6864
</p><p style="padding-left: 30px;">* Stack = 52240384 / 52559872
</p><p style="padding-left: 30px;">* MSpan = 34048 / 49152
</p><p style="padding-left: 30px;">* MCache = 2200 / 16384
</p><p style="padding-left: 30px;">* BuckHashSys = 1440664
</p><p style="padding-left: 30px;">* NextGC = 4418096
</p><p style="padding-left: 30px;">* PauseNs = [179012 231633 4966871</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>string</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>go version 1.3
</p><p style="padding-left: 30px;">*  HeapObjects = 5645
</p><p style="padding-left: 30px;">*  Stack = 42614784 / 42860544
</p><p style="padding-left: 30px;">*  MSpan = 28416 / 32768
</p><p style="padding-left: 30px;">*  MCache = 2200 / 16384
</p><p style="padding-left: 30px;">*  BuckHashSys = 1440664
</p><p style="padding-left: 30px;">*  NextGC = 3404880</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>go version 1.2
</p><p style="padding-left: 30px;">*  HeapObjects = 10080
</p><p style="padding-left: 30px;">*  Stack = 81494016 / 81657856
</p><p style="padding-left: 30px;">*  MSpan = 77792 / 81920
</p><p style="padding-left: 30px;">*  MCache = 1504 / 16384
</p><p style="padding-left: 30px;">*  BuckHashSys = 1480664
</p><p style="padding-left: 30px;">*  NextGC = 6373392
</p><p style="padding-left: 30px;">*  PauseNs = [164000 57000 4911836</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>map</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>1.3
</p><p style="padding-left: 30px;">*  map[int]string *
</p><p style="padding-left: 30px;">*  HeapObjects = 6274
</p><p style="padding-left: 30px;">*  Stack = 42459136 / 42598400
</p><p style="padding-left: 30px;">*  MSpan = 31104 / 32768
</p><p style="padding-left: 30px;">*  MCache = 2200 / 16384
</p><p style="padding-left: 30px;">*  BuckHashSys = 1441104
</p><p style="padding-left: 30px;">*  NextGC = 3121360
</p><p style="padding-left: 30px;">*  PauseNs = [124703 3325897</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>map[int]struct</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>HeapObjects = 6571</li>
</p><p style="padding-left: 30px;"><li>Stack = 44220416 / 44433408</li>
</p><p style="padding-left: 30px;"><li>MSpan = 32128 / 32768</li>
</p><p style="padding-left: 30px;"><li>MCache = 2200 / 16384</li>
</p><p style="padding-left: 30px;"><li>BuckHashSys = 1441336</li>
</p><p style="padding-left: 30px;"><li>NextGC = 2995568</li>
</p><p style="padding-left: 30px;"><li>PauseNs = [132551 2436114</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>map[int]*struct</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>HeapReleased = 0</li>
</p><p style="padding-left: 30px;"><li>HeapObjects = 16796</li>
</p><p style="padding-left: 30px;"><li>Stack = 46153728 / 46399488</li>
</p><p style="padding-left: 30px;"><li>MSpan = 35328 / 49152</li>
</p><p style="padding-left: 30px;"><li>MCache = 2200 / 16384</li>
</p><p style="padding-left: 30px;"><li>BuckHashSys = 1441112</li>
</p><p style="padding-left: 30px;"><li>NextGC = 2858128</li>
</p><p style="padding-left: 30px;"><li>PauseNs = [152215 2232194</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>[] *struct</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>HeapObjects = 15898</li>
</p><p style="padding-left: 30px;"><li>Stack = 43950080 / 44171264</li>
</p><p style="padding-left: 30px;"><li>MSpan = 31872 / 32768</li>
</p><p style="padding-left: 30px;"><li>MCache = 2200 / 16384</li>
</p><p style="padding-left: 30px;"><li>BuckHashSys = 1441080</li>
</p><p style="padding-left: 30px;"><li>NextGC = 3177328</li>
</p><p style="padding-left: 30px;"><li>PauseNs = [133127 169560 2927747</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h5>[]struct</h5>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>HeapObjects = 5684</li>
</p><p style="padding-left: 30px;"><li>Stack = 42909696 / 43122688</li>
</p><p style="padding-left: 30px;"><li>MSpan = 28800 / 32768</li>
</p><p style="padding-left: 30px;"><li>MCache = 2200 / 16384</li>
</p><p style="padding-left: 30px;"><li>BuckHashSys = 1440664</li>
</p><p style="padding-left: 30px;"><li>NextGC = 3753936</li>
</p><p style="padding-left: 30px;"><li>PauseNs = [125426 194529 2964888</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>数据结论</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>[]struct 是生成对象最少的</li>
</p><p style="padding-left: 30px;"><li>string 和 slice 的生成对象差不多</li>
</p><p style="padding-left: 30px;"><li>go1.3 在对象生成数量上做了优化</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h3>使用 memory pool</h3>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>考虑减少对象的 gc 时间可以从常驻内存入手</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>使用  chan chan 来做为 memory pool</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>mempool := make(chan *memStruct, count)
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>申请 memStruct</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>structPointer := &lt;- mempool
</p><p style="padding-left: 30px;"></code></pre>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h4>用完回放</h4>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><pre><code>mempool&lt;-structPointer
</p><p style="padding-left: 30px;"></code></pre>
</p></div>
</div>
<div id="post-449" class="post-449 post type-post status-publish format-standard hentry category-64 tag-django tag-vps tag-150 tag-4">
<h2 class="entry-title"> <font color="green">golang 手机游戏服务器 &amp;lt;一&amp;gt;</font> </h2>
<div class="entry-meta">2014-12-02 17:02</div>
<div class="entry-content clearfix"><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>最近想做一个休闲类游戏服务器, 能够实现一个简单的游戏服务器. 目标是保证服务稳定性以及可伸缩性能.</p>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>网络选择</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><ul>
</p><p style="padding-left: 30px;"><li>tcp  golang/erlang 大大简化了 tcp 的使用, 使用 tcp 网络协议标准是, 我们的客户端, 对于网络丢包产生的影响. 因为是轻休闲类的游戏，是可以考虑 tcp 的.</li>
</p><p style="padding-left: 30px;"><li>udp 发包不确认, 但是对服务端网络压力不大. 一个用户的数据发送出问题, 也不会影响其它用户.</li>
</p><p style="padding-left: 30px;"><li>http 携带了很多 http 协议的数据, 不考虑.</li>
</p><p style="padding-left: 30px;"><li>websocket 主要是用在浏览器客户端上, 持久连接. 不考虑.</li>
</p><p style="padding-left: 30px;"></ul>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><h2>语言的选择</h2>
</p><p style="padding-left: 30px;">
</p><p style="padding-left: 30px;"><p>要使用支持协程的语言, 这种并发方式比较简单易懂. 经过多方考虑, 最终选择 golang 做为开发语言.
</p><p style="padding-left: 30px;">*  c++ 对于非专业 c++ programmer 来说难度稍大, 放弃.
</p><p style="padding-left: 30px;">*  erlang 的 otp 提供了强大了网络框架, 并且能提供热更. 但以 erlang game server 为 keyword 从 github 找源码, 发现大部分已经断更, 在 erlang 17 环境下无法编译通过, 加上 erlang 的代码看起来很难懂, 遂放弃之. 另外的问题是, CPU 不好做 profile ,内存使用较高,不适合计算密集型. 写逻辑复杂. 可以考虑后期加强服务伸缩性使用它来做网络框架,然后进程间通信到 golang/rustlang 做逻辑.
</p><p style="padding-left: 30px;">*  rustlang 稍微复杂的内存管理模型, 个人体会 closure 很强大, 另外使用模式匹配比 erlang 可读性强. 但是目前版本变化很大, 1.0 发布遥遥无期(官方称年底发布). 可后期观望.
</p><p style="padding-left: 30px;">*  golang 是近一年我所用的语言, gc 稍微有些问题, 据说 1.5 版本会修改 gc 算法, 值得期待. 包导出函数和变量需首字母大写, 感觉很别扭. 但考虑到简单强大, golang 还是很强力的.
</p><p style="padding-left: 30px;">*  nodejs 的异步方法跟上面几种语言的都不同. 因为异步回掉写起来很随意, 导致代码里面各种又臭又长的异步回掉. 默认不支持多 cpu. 弱的类型检查. 总之就是写的时候爽, 运行时易出错, 读的时候各种痛苦.</p>
</p></div>
</div>
		  <!--appendend-->
		</div>
	  </div>
	</div>
  </div>
</body>
